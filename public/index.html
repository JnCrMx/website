<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCM's website</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script type="module">
        function get_string(instance, ptr, len) {
            const cArray = new Uint8Array(instance.exports.memory.buffer, ptr, len);
            return new TextDecoder().decode(cArray);
        }
        function stringifyEvent(e) {
            const obj = {};
            for (let k in e) {
                obj[k] = e[k];
            }
            return JSON.stringify(obj, (k, v) => {
                if (v instanceof Node) return 'Node';
                if (v instanceof Window) return 'Window';
                return v;
            }, ' ');
        }
        function copy_string(instance, s) {
            const buffer = new TextEncoder().encode(s);
            const str_ptr = instance.exports.new_string(buffer.length);
            const data = new Uint8Array(instance.exports.memory.buffer, str_ptr, buffer.length);
            data.set(buffer);
            return [str_ptr, buffer.length];
        }
        function copy_string_null(instance, s) {
            const buffer = new TextEncoder().encode(s);
            const str_ptr = instance.exports.new_string(buffer.length+1);
            const data = new Uint8Array(instance.exports.memory.buffer, str_ptr, buffer.length+1);
            data.set(buffer);
            data[buffer.length] = 0;
            return [str_ptr, buffer.length];
        }
        function delete_string(instance, ptr) {
            instance.exports.delete_string(ptr);
        }


        async function init() {
            const importObject = {
                env: {
                    eval: (ptr, len) => {
                        eval(get_string(instance, ptr, len));
                    },
                    set_html: (id_ptr, id_len, html_ptr, html_len) => {
                        const id = get_string(instance, id_ptr, id_len);
                        document.getElementById(id).innerHTML = get_string(instance, html_ptr, html_len);
                    },
                    set_property: (id_ptr, id_len, property_ptr, property_len, value_ptr, value_len) => {
                        const id = get_string(instance, id_ptr, id_len);
                        const property = get_string(instance, property_ptr, property_len);
                        const value = get_string(instance, value_ptr, value_len);
                        console.log(id, property, value);
                        document.getElementById(id)[property] = value;
                    },
                    get_property: (id_ptr, id_len, property_ptr, property_len) => {
                        const id = get_string(instance, id_ptr, id_len);
                        const property = get_string(instance, property_ptr, property_len);
                        const [str_ptr, len] = copy_string_null(instance, document.getElementById(id)[property]);
                        return str_ptr;
                    },
                    log: (ptr, len) => {
                        console.log(get_string(instance, ptr, len));
                    },
                    add_event_listener: (id_ptr, id_len, event_ptr, event_len, ptr, once) => {
                        const id = get_string(instance, id_ptr, id_len);
                        const event = get_string(instance, event_ptr, event_len);
                        document.getElementById(id).addEventListener(event, (e) => {
                            e.preventDefault();
                            const [str_ptr, len] = copy_string(instance, stringifyEvent(e));
                            instance.exports.callback(ptr, str_ptr, len);
                            delete_string(instance, str_ptr);
                        }, { once: once });
                    },
                    set_timeout: (ms, ptr) => {
                        setTimeout(() => {
                            instance.exports.callback(ptr, 0, 0);
                        }, ms);
                    },
                },
                wasi_snapshot_preview1: {
                    fd_close: () => { console.log("fd_close"); },
                    fd_seek: () => { console.log("fd_seek"); },
                    fd_write: () => { console.log("fd_write"); },
                    environ_get: () => { console.log("environ_get"); },
                    environ_sizes_get: () => { console.log("environ_sizes_get"); },
                    proc_exit: () => { console.log("proc_exit"); },
                    random_get(buf, buf_len) {
                        const data = new Uint8Array(instance.exports.memory.buffer, buf, buf_len);
                        for (let i = 0; i < buf_len; ++i) {
                            data[i] = (Math.random() * 256) | 0;
                        }
                    }
                }
            };

            const { instance } = await WebAssembly.instantiateStreaming(
                fetch("./website.wasm"), importObject
            );
            instance.exports._initialize();
            instance.exports.main();
        }
        init();
    </script>
    <main id="main">

    </main>
</body>

</html>